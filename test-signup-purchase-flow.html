<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Sign Up ‚Üí Purchase Flow</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .test-panel {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .status {
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      font-weight: 500;
    }
    
    .status.pending {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
    }
    
    .status.success {
      background: #d4edda;
      border: 1px solid #28a745;
      color: #155724;
    }
    
    .status.error {
      background: #f8d7da;
      border: 1px solid #dc3545;
      color: #721c24;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px 10px 0;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px;
    }
    
    .log-entry.info {
      color: #0056b3;
    }
    
    .log-entry.success {
      color: #28a745;
    }
    
    .log-entry.error {
      color: #dc3545;
    }
    
    .instructions {
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      padding: 15px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="test-panel">
    <h1>üß™ Sign Up ‚Üí Purchase Flow Test</h1>
    <p>This test verifies that the auth state verification works properly after signup.</p>
    
    <div class="instructions">
      <strong>Test Instructions:</strong>
      <ol>
        <li>Click "Start Test Flow" below</li>
        <li>The script will simulate clicking "Rent"</li>
        <li>It will then simulate signing up a new user</li>
        <li>Finally, it should automatically proceed to Stripe checkout</li>
      </ol>
    </div>
    
    <div id="status" class="status pending">
      Status: Ready to test
    </div>
    
    <button id="testBtn" onclick="startTest()">Start Test Flow</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div class="log" id="log"></div>
  </div>
  
  <script>
    let testEmail = '';
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }
    
    function updateStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = `Status: ${message}`;
      statusDiv.className = `status ${type}`;
    }
    
    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }
    
    async function startTest() {
      const btn = document.getElementById('testBtn');
      btn.disabled = true;
      
      clearLog();
      log('üöÄ Starting sign up ‚Üí purchase flow test...', 'info');
      updateStatus('Test in progress...', 'pending');
      
      try {
        // Step 1: Check if we're on the right page
        log('Step 1: Checking page URL...', 'info');
        const currentUrl = window.location.href;
        
        if (!currentUrl.includes('webflow.io') && !currentUrl.includes('localhost')) {
          throw new Error('Please run this test on the Webflow site or local test server');
        }
        
        log('‚úì URL check passed', 'success');
        
        // Step 2: Check if scripts are loaded
        log('Step 2: Checking if required scripts are loaded...', 'info');
        
        if (!window.timBurtonAuth) {
          throw new Error('Auth system not loaded');
        }
        log('‚úì Auth system loaded', 'success');
        
        if (!window.buttonStateManager) {
          throw new Error('Button state manager not loaded');
        }
        log('‚úì Button state manager loaded', 'success');
        
        if (!window.stripeIntegration) {
          throw new Error('Stripe integration not loaded');
        }
        log('‚úì Stripe integration loaded', 'success');
        
        // Step 3: Check current auth state
        log('Step 3: Checking current auth state...', 'info');
        const isSignedIn = window.timBurtonAuth.isSignedIn();
        log(`Current sign-in status: ${isSignedIn}`, 'info');
        
        if (isSignedIn) {
          log('‚ö†Ô∏è User is already signed in. Sign out first to test signup flow.', 'error');
          updateStatus('Please sign out first to test signup flow', 'error');
          btn.disabled = false;
          return;
        }
        
        log('‚úì User is signed out (ready for test)', 'success');
        
        // Step 4: Simulate clicking "Rent" button
        log('Step 4: Simulating "Rent" button click...', 'info');
        
        // Set intended action manually
        window.buttonStateManager.intendedAction = 'rent';
        log('‚úì Intended action set to "rent"', 'success');
        
        // Step 5: Test auth state verification
        log('Step 5: Testing waitForAuthReady function...', 'info');
        
        // First test: should fail (not signed in yet)
        log('Testing: Auth should NOT be ready (user not signed in)', 'info');
        const notReady = await window.buttonStateManager.waitForAuthReady(3, 50);
        
        if (notReady) {
          throw new Error('Auth incorrectly reported as ready when user is not signed in!');
        }
        log('‚úì Correctly identified auth is not ready', 'success');
        
        // Step 6: Instructions for manual signup
        log('Step 6: Manual signup required...', 'info');
        log('‚ö†Ô∏è NEXT STEP: Please click "Sign In" and create a test account', 'info');
        log('The system will automatically trigger the purchase flow after signup', 'info');
        
        updateStatus('Waiting for you to sign up... (Click Sign In button)', 'pending');
        
        // Listen for auth event
        document.addEventListener('timBurtonAuth', async (event) => {
          if (event.detail.type === 'signUp' || event.detail.type === 'signIn') {
            log('‚úì Auth event detected: ' + event.detail.type, 'success');
            log('Step 7: Verifying auth state after signup...', 'info');
            
            // Test again: should succeed now
            const ready = await window.buttonStateManager.waitForAuthReady(10, 50);
            
            if (!ready) {
              log('‚ùå Auth state verification FAILED after signup!', 'error');
              updateStatus('Test FAILED: Auth not ready after signup', 'error');
              return;
            }
            
            log('‚úì Auth state verification PASSED!', 'success');
            log('‚úì User is signed in and ready for purchase', 'success');
            
            const user = window.timBurtonAuth.getCurrentUser();
            log(`Signed in as: ${user.email}`, 'info');
            
            updateStatus('Test PASSED! Auth state verification working correctly', 'success');
            
            log('üéâ Test completed successfully!', 'success');
            log('Note: Intended action will execute automatically if set', 'info');
            
            btn.disabled = false;
          }
        }, { once: true });
        
      } catch (error) {
        log(`‚ùå Test failed: ${error.message}`, 'error');
        updateStatus(`Test failed: ${error.message}`, 'error');
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>



