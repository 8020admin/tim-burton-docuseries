# Account Page Integration Guide

Complete guide for implementing the account page in Webflow with purchase history, profile management, and receipt downloads.

---

## üìö Table of Contents

1. [Overview](#overview)
2. [Required Scripts](#required-scripts)
3. [Authentication & Redirect](#authentication--redirect)
4. [Profile Display & Edit](#profile-display--edit)
5. [Purchase History](#purchase-history)
6. [Profile Updates](#profile-updates)
7. [Complete Examples](#complete-examples)
8. [Testing Guide](#testing-guide)

---

## üéØ Overview

The account page shows authenticated users:
- ‚úÖ Profile information (name, email, photo)
- ‚úÖ Purchase history with dates and amounts
- ‚úÖ Download Stripe receipts
- ‚úÖ Edit first name, email, and password
- ‚úÖ **Auto-redirect if not signed in**

---

## üìã Required Scripts

Add to your Webflow account page **Settings ‚Üí Custom Code ‚Üí Before `</body>` tag**:

```html
<!-- Account Page Script -->
<script src="https://tim-burton-docuseries.pages.dev/js/account-page.js"></script>
```

**Full script load order:**
```html
<!-- In <head> or Project Settings ‚Üí Custom Code ‚Üí Head -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://tim-burton-docuseries.pages.dev/js/client-auth.js"></script>

<!-- In page settings ‚Üí Before </body> -->
<script src="https://tim-burton-docuseries.pages.dev/js/account-page.js"></script>
```

---

## üîê Authentication & Redirect

### **Auto-Redirect for Non-Authenticated Users**

The account page automatically redirects users who aren't signed in to the homepage after 1 second.

**No additional setup needed!** The `account-page.js` script handles this automatically.

**How it works:**
```javascript
1. Page loads
2. Check if user is signed in
3. If NOT signed in ‚Üí Redirect to '/' (homepage)
4. If signed in ‚Üí Load account data
```

**Optional: Show redirect message**

Add this element to show a message before redirect:

```html
<div data-account-message style="display: none;">
  <!-- Message will appear here before redirect -->
</div>
```

---

## üë§ Profile Display & Edit

### **Profile Image**

```html
<img data-profile-image src="" alt="Profile picture" />
```

- Automatically populated with user's photo
- Falls back to default avatar if not set

---

### **First Name (Display & Edit)**

**For Display:**
```html
<div data-profile-first-name>User</div>
```

**For Editing:**
```html
<input type="text" data-profile-first-name placeholder="First Name" />
```

- If element is `<input>`, value is set (editable)
- If element is `<div>`, textContent is set (display only)

---

### **Last Name (Display & Edit)**

**For Display:**
```html
<div data-profile-last-name></div>
```

**For Editing:**
```html
<input type="text" data-profile-last-name placeholder="Last Name" />
```

---

### **Email (Display)**

```html
<div data-profile-email-display>email@example.com</div>
```

- Shows current email address
- Read-only display

---

### **Email (Edit)**

```html
<input type="email" data-profile-email-input placeholder="Email" />
```

- For editing email address
- Separate from display field

---

## üõí Purchase History

### **Purchase History Container**

```html
<div data-purchase-history>
  <!-- Purchase items will be dynamically inserted here -->
</div>
```

**Automatically Displays:**
- Product name (Rental, Regular, or Box Set)
- Purchase date
- Amount paid
- Rental expiration (if applicable)
- "Download Receipt" button for each purchase

**If no purchases:**
Shows "No purchases yet."

---

### **Individual Purchase Item Structure (Auto-Generated)**

Each purchase is displayed as:

```html
<div data-purchase-item class="purchase-item">
  <div data-purchase-product-name>Tim Burton Docuseries - Box Set</div>
  <div data-purchase-date>10/13/2025</div>
  <div data-purchase-amount>$74.99 USD</div>
  <div data-purchase-expiration>
    <span class="active">Expires: 10/17/2025</span>
    <!-- OR -->
    <span class="expired">Expired</span>
  </div>
  <button data-download-receipt data-purchase-id="xxx">
    Download Receipt
  </button>
</div>
```

**Note:** This is auto-generated by JavaScript. You only need the container `[data-purchase-history]`.

---

## ‚úèÔ∏è Profile Updates

### **Update First Name**

**Setup:**

```html
<!-- Input field -->
<input type="text" data-profile-first-name placeholder="First Name" />

<!-- Save button -->
<button data-update-first-name>Save First Name</button>
```

**‚úÖ Automatic!** The event handler is automatically attached by `account-page.js` - no custom code needed.

---

### **Update Email**

**Setup:**

```html
<!-- Email input -->
<input type="email" data-profile-email-input placeholder="New Email" />

<!-- Save button -->
<button data-update-email>Update Email</button>
```

**‚úÖ Automatic!** The event handler is automatically attached by `account-page.js` - no custom code needed.

**Important:**
- Sends verification email to new address
- User must re-authenticate if signed in for a while
- Uses Firebase Auth (client-side)

---

### **Update Password**

**Setup:**

```html
<form data-form="update-password">
  <!-- Current Password -->
  <input type="password" data-current-password placeholder="Current Password" required />
  
  <!-- New Password -->
  <input type="password" data-new-password placeholder="New Password" required />
  
  <!-- Confirm Password -->
  <input type="password" data-confirm-password placeholder="Confirm New Password" required />
  
  <!-- Submit Button -->
  <button type="submit" data-update-password>Update Password</button>
</form>
```

**‚úÖ Automatic!** The event handler is automatically attached by `account-page.js` - no custom code needed.

**Password Requirements (Same as Signup):**
- Minimum 8 characters
- At least one uppercase letter
- At least one lowercase letter
- At least one number

---

## üìÑ Receipt Download

Receipt download is **automatically handled** for each purchase.

**How it works:**

1. User clicks "Download Receipt" button
2. Backend fetches Stripe receipt URL
3. Opens receipt in new tab
4. Receipt is served directly by Stripe

**Stripe Receipt URL Format:**
```
https://pay.stripe.com/receipts/[session_id]
```

**No additional setup needed!**

---

## üí¨ Feedback Messages

### **Loading State**

```html
<div data-account-loading style="display: none;">
  Loading...
</div>
```

- Shows during async operations
- Automatically hidden when complete

---

### **Success Messages**

```html
<div data-account-success style="display: none;"></div>
```

- Shows success messages (e.g., "First name updated!")
- Auto-hides after 5 seconds

---

### **Error Messages**

```html
<div data-account-error style="display: none;"></div>
```

- Shows error messages (e.g., "Failed to update email")
- Auto-hides after 5 seconds

---

## üé® Complete Examples

### **Minimal Account Page**

```html
<!-- Auto-redirect if not signed in (no setup needed) -->

<!-- Profile Section -->
<div class="profile-section">
  <h2>Your Profile</h2>
  <img data-profile-image src="" alt="Profile" />
  <div data-profile-first-name>User</div>
  <div data-profile-email-display>email@example.com</div>
</div>

<!-- Purchase History -->
<div class="purchases-section">
  <h2>Purchase History</h2>
  <div data-purchase-history>
    <!-- Auto-populated -->
  </div>
</div>
```

---

### **Full Account Page with Editing**

```html
<!DOCTYPE html>
<html>
<head>
  <title>My Account - Tim Burton Docuseries</title>
  
  <!-- Firebase & Auth Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://tim-burton-docuseries.pages.dev/js/client-auth.js"></script>
</head>
<body>
  
  <!-- Loading State -->
  <div data-account-loading style="display: none;">Loading your account...</div>
  
  <!-- Success/Error Messages -->
  <div data-account-success style="display: none;"></div>
  <div data-account-error style="display: none;"></div>
  
  <!-- Profile Section -->
  <section class="profile-section">
    <h2>Your Profile</h2>
    
    <div class="profile-image">
      <img data-profile-image src="" alt="Profile picture" />
    </div>
    
    <div class="profile-form">
      <!-- First Name -->
      <div class="form-group">
        <label>First Name</label>
        <input type="text" data-profile-first-name placeholder="First Name" />
        <button data-update-first-name>Save</button>
      </div>
      
      <!-- Email (Display) -->
      <div class="form-group">
        <label>Current Email</label>
        <div data-profile-email-display></div>
      </div>
      
      <!-- Email (Edit) -->
      <div class="form-group">
        <label>New Email</label>
        <input type="email" data-profile-email-input placeholder="New Email" />
        <button data-update-email>Update Email</button>
      </div>
    </div>
  </section>
  
  <!-- Password Update Section -->
  <section class="password-section">
    <h2>Change Password</h2>
    <form data-form="update-password">
      <div class="form-group">
        <label>Current Password</label>
        <input type="password" data-current-password placeholder="Current Password" required />
      </div>
      
      <div class="form-group">
        <label>New Password</label>
        <input type="password" data-new-password placeholder="New Password" required />
      </div>
      
      <div class="form-group">
        <label>Confirm New Password</label>
        <input type="password" data-confirm-password placeholder="Confirm New Password" required />
      </div>
      
      <button type="submit" data-update-password>Update Password</button>
    </form>
  </section>
  
  <!-- Purchase History Section -->
  <section class="purchases-section">
    <h2>Purchase History</h2>
    <div data-purchase-history>
      <!-- Auto-populated with purchases -->
    </div>
  </section>
  
  <!-- Account Page Script (MUST be after auth scripts) -->
  <script src="https://tim-burton-docuseries.pages.dev/js/account-page.js"></script>
  
  <!-- Event handlers are automatically attached - no custom code needed! -->
</body>
</html>
```

---

## üß™ Testing Guide

### **1. Test Authentication Redirect**

1. Sign out from your account
2. Navigate directly to `/account` page
3. **Expected:** Redirected to homepage within 1 second
4. **Optional:** See message "Please sign in to view your account"

---

### **2. Test Profile Display**

1. Sign in to your account
2. Navigate to `/account` page
3. **Expected:**
   - Profile image displayed
   - First name displayed
   - Email displayed
   - Purchase history loaded (if any purchases)

---

### **3. Test First Name Update**

1. Change first name in input field
2. Click "Save" button
3. **Expected:**
   - Success message: "First name updated successfully!"
   - Name updated in profile
   - Changes persist on page refresh

---

### **4. Test Email Update**

1. Enter new email in email input
2. Click "Update Email" button
3. **Expected:**
   - Success message: "Email updated! Please check your inbox for verification email."
   - Verification email sent to new address
   - Email updated in profile

**If Error:** "Please sign out and sign in again" ‚Üí User has been signed in for a long time (Firebase security)

---

### **5. Test Password Update**

1. Enter current password
2. Enter new password (must meet requirements)
3. Confirm new password
4. Click "Update Password"
5. **Expected:**
   - Success message: "Password updated successfully!"
   - Password fields cleared
   - Can sign in with new password

**Common Errors:**
- "Current password is incorrect" ‚Üí Wrong current password
- "New passwords do not match" ‚Üí Confirmation doesn't match
- "Password must be at least 8 characters..." ‚Üí Weak password

---

### **6. Test Purchase History**

**If No Purchases:**
- Shows: "No purchases yet."

**If Has Purchases:**
- Each purchase shows:
  - Product name
  - Purchase date
  - Amount
  - Expiration (if rental)
  - "Download Receipt" button

---

### **7. Test Receipt Download**

1. Click "Download Receipt" button on any purchase
2. **Expected:**
   - New tab opens with Stripe receipt
   - Receipt shows product, amount, payment method

**If Error:** "Receipt URL not available" ‚Üí Contact support

---

## üìä Quick Reference Table

| Element | Attribute | Type | Purpose |
|---------|-----------|------|---------|
| Profile Image | `data-profile-image` | `<img>` | User photo |
| First Name (Display) | `data-profile-first-name` | `<div>` | Show name |
| First Name (Edit) | `data-profile-first-name` | `<input>` | Edit name |
| Email Display | `data-profile-email-display` | `<div>` | Show email |
| Email Input | `data-profile-email-input` | `<input>` | Edit email |
| Current Password | `data-current-password` | `<input>` | Current password |
| New Password | `data-new-password` | `<input>` | New password |
| Confirm Password | `data-confirm-password` | `<input>` | Confirm password |
| Purchase History | `data-purchase-history` | `<div>` | Purchase container |
| Loading Message | `data-account-loading` | `<div>` | Loading state |
| Success Message | `data-account-success` | `<div>` | Success feedback |
| Error Message | `data-account-error` | `<div>` | Error feedback |
| Update First Name Btn | `data-update-first-name` | `<button>` | Save first name |
| Update Email Btn | `data-update-email` | `<button>` | Save email |
| Update Password Btn | `data-update-password` | `<button>` | Save password |

---

## üéì Advanced: Custom Styling

All purchase items have `data-purchase-item` attribute for styling:

```css
[data-purchase-item] {
  padding: 20px;
  border: 1px solid #ddd;
  margin-bottom: 15px;
  border-radius: 8px;
}

[data-purchase-product-name] {
  font-weight: bold;
  font-size: 18px;
}

[data-purchase-date] {
  color: #666;
}

[data-purchase-amount] {
  font-weight: bold;
  color: #4CAF50;
}

.expired {
  color: #f44336;
  font-weight: bold;
}

.active {
  color: #2196F3;
  font-weight: bold;
}
```

---

## ‚úÖ Implementation Checklist

- [ ] Add `account-page.js` script to page
- [ ] Add profile image element `[data-profile-image]`
- [ ] Add first name display/edit `[data-profile-first-name]`
- [ ] Add email display `[data-profile-email-display]`
- [ ] Add email edit input `[data-profile-email-input]`
- [ ] Add password update form (current, new, confirm)
- [ ] Add purchase history container `[data-purchase-history]`
- [ ] Add update buttons with click handlers
- [ ] Add success/error message containers
- [ ] Add loading state indicator
- [ ] Test auth redirect
- [ ] Test profile display
- [ ] Test all update functions
- [ ] Test receipt downloads

---

## üÜò Troubleshooting

**Problem:** Page doesn't redirect non-authenticated users

**Solution:** 
- Check that `account-page.js` is loading
- Check browser console for errors
- Verify `client-auth.js` loads before `account-page.js`

---

**Problem:** Profile fields not populating

**Solution:**
- Check that attributes match exactly (e.g., `data-profile-first-name`)
- Verify user is signed in
- Check browser console for JavaScript errors

---

**Problem:** "Failed to update email" with recent login error

**Solution:**
- User needs to sign out and sign in again
- This is a Firebase security feature
- Tell user: "For security, please sign out and sign in again before changing your email"

---

**Problem:** Receipt download not working

**Solution:**
- Check that purchase has `stripeSessionId` in database
- Verify `/payments/receipt/:purchaseId` endpoint is accessible
- Check browser console for errors

---

## üìö Related Documentation

- [Webflow Integration Guide](WEBFLOW_INTEGRATION.md)
- [Password Validation Changes](PASSWORD_VALIDATION_CHANGES.md)
- [Stripe Guide](STRIPE_GUIDE.md)
- [Firebase Guide](FIREBASE_GUIDE.md)

---

## üéâ Ready to Deploy!

Your account page is now fully integrated with:
- ‚úÖ Auto-redirect for non-authenticated users
- ‚úÖ Profile display and editing
- ‚úÖ Purchase history with dates and amounts
- ‚úÖ Stripe receipt downloads
- ‚úÖ Secure password updates
- ‚úÖ Email updates with verification

**Last Updated:** 2025-10-13  
**Status:** Production Ready

